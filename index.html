<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>頭皮健康分析儀</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">

    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-2xl text-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-gray-800">頭皮健康分析儀</h1>

        <!-- 影片預覽區域 -->
        <div class="relative w-full aspect-video bg-gray-200 rounded-xl overflow-hidden mb-6">
            <video id="videoElement" class="w-full h-full object-cover" autoplay playsinline></video>
            <canvas id="snapshotCanvas" class="hidden absolute top-0 left-0 w-full h-full object-cover"></canvas>
            <div id="pixelInfo" class="absolute bottom-2 left-2 text-white bg-black bg-opacity-50 px-2 py-1 rounded-md text-sm transition-opacity duration-300 opacity-0"></div>
            <div id="analysisBox" class="absolute top-0 left-0 border-2 border-red-500 hidden pointer-events-none"></div>
        </div>

        <!-- 按鈕區域 -->
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
            <button id="captureButton" class="w-full sm:w-1/2 bg-blue-600 text-white font-semibold py-3 rounded-xl shadow-md hover:bg-blue-700 transition-colors duration-200">
                截圖分析
            </button>
            <button id="resetButton" class="w-full sm:w-1/2 bg-gray-500 text-white font-semibold py-3 rounded-xl shadow-md hover:bg-gray-600 transition-colors duration-200">
                重置相機
            </button>
        </div>

        <!-- 指示文字 -->
        <p class="text-gray-600 text-sm sm:text-base">請將相機對準頭皮，然後按下「截圖分析」按鈕。</p>
    </div>

    <script>
        // 取得 HTML 元素
        const videoElement = document.getElementById('videoElement');
        const snapshotCanvas = document.getElementById('snapshotCanvas');
        const captureButton = document.getElementById('captureButton');
        const resetButton = document.getElementById('resetButton');
        const pixelInfoDiv = document.getElementById('pixelInfo');
        const analysisBox = document.getElementById('analysisBox');
        const context = snapshotCanvas.getContext('2d', { willReadFrequently: true });

        // 相機預覽設定
        const constraints = {
            video: {
                facingMode: 'environment', // 優先使用後置鏡頭
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // 啟動相機
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = stream;
                videoElement.classList.remove('hidden');
                snapshotCanvas.classList.add('hidden');
                analysisBox.classList.add('hidden');
                pixelInfoDiv.classList.add('opacity-0');
            } catch (err) {
                console.error("無法啟動相機:", err);
                alert('無法啟動相機。請檢查您的瀏覽器權限設定。');
            }
        }

        // 捕捉畫面
        function captureFrame() {
            // 設定 Canvas 尺寸與影片尺寸相同
            snapshotCanvas.width = videoElement.videoWidth;
            snapshotCanvas.height = videoElement.videoHeight;
            
            // 將影片畫面繪製到 Canvas 上
            context.drawImage(videoElement, 0, 0, snapshotCanvas.width, snapshotCanvas.height);

            // 隱藏影片，顯示截圖
            videoElement.srcObject.getTracks().forEach(track => track.stop());
            videoElement.classList.add('hidden');
            snapshotCanvas.classList.remove('hidden');

            // 提示使用者點擊分析
            pixelInfoDiv.textContent = '點擊圖片以分析像素';
            pixelInfoDiv.classList.remove('opacity-0');
        }

        // 重置相機
        function resetCamera() {
            startCamera();
        }

        // 分析像素功能
        snapshotCanvas.addEventListener('click', (event) => {
            const rect = snapshotCanvas.getBoundingClientRect();
            const scaleX = snapshotCanvas.width / rect.width;
            const scaleY = snapshotCanvas.height / rect.height;

            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;

            // 繪製分析框 (50x50 像素)
            const boxSize = 50;
            const boxX = Math.max(0, Math.min(snapshotCanvas.width - boxSize, x - boxSize / 2));
            const boxY = Math.max(0, Math.min(snapshotCanvas.height - boxSize, y - boxSize / 2));

            // 更新分析框的樣式和位置
            analysisBox.style.left = `${(boxX / scaleX) - 1}px`; // 減去邊框寬度
            analysisBox.style.top = `${(boxY / scaleY) - 1}px`; // 減去邊框寬度
            analysisBox.style.width = `${boxSize / scaleX}px`;
            analysisBox.style.height = `${boxSize / scaleY}px`;
            analysisBox.classList.remove('hidden');

            // 取得分析框內的像素資料
            const imageData = context.getImageData(boxX, boxY, boxSize, boxSize);
            let totalR = 0, totalG = 0, totalB = 0;
            const numPixels = imageData.data.length / 4;

            for (let i = 0; i < imageData.data.length; i += 4) {
                totalR += imageData.data[i];
                totalG += imageData.data[i + 1];
                totalB += imageData.data[i + 2];
            }

            const avgR = Math.round(totalR / numPixels);
            const avgG = Math.round(totalG / numPixels);
            const avgB = Math.round(totalB / numPixels);

            // 顯示像素資訊
            pixelInfoDiv.textContent = `平均 RGB: (${avgR}, ${avgG}, ${avgB})`;
            pixelInfoDiv.classList.remove('opacity-0');
        });

        // 按鈕事件監聽
        captureButton.addEventListener('click', captureFrame);
        resetButton.addEventListener('click', resetCamera);

        // 初始化
        window.onload = startCamera;
    </script>
</body>
</html>
